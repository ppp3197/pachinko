<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>카드 뽑기 시뮬레이터</title>
<style>
  :root{--bg:#0b0c10;--card:#16181d;--muted:#9aa4b2;--text:#e6e9ef;--accent:#3ddc84;
    --r-perfect:#b786ff;--r-select:#42a5f5;--r-optimal:#26c6da;--r-tactical:#ffd54f;--r-common:#b0bec5;}
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(120deg,#0b0c10,#111418);
  color:var(--text);font:15px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:20px}
  h1{margin:0 0 8px;font-size:28px;font-weight:800}
  .sub{color:var(--muted);margin-bottom:16px}
  .panel{background:var(--card);border:1px solid #22272e;border-radius:16px;padding:16px;margin:12px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button{background:#1d222a;color:#fff;border:1px solid #2a2f36;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  button.primary{background:var(--accent);color:#0e2f22;border-color:#1f7e56}
  button:disabled{opacity:.6;cursor:not-allowed}
  .result{display:flex;align-items:center;gap:14px;padding:14px;border-radius:12px;border:1px solid #2a2f36;background:#0f1115;min-height:72px}
  .pill{padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px}
  .tag{font-size:12px;border-radius:999px;padding:4px 8px;border:1px solid #2a2f36;color:var(--muted)}
  .ok{color:#6ee7b7}.warn{color:#fbbf24}.bad{color:#f87171}
  .hist{max-height:240px;overflow:auto;border:1px dashed #2a2f36;border-radius:12px;padding:10px;background:#0e1014}
  .hist div{display:flex;justify-content:space-between;padding:6px 4px;border-bottom:1px solid #181c22}
  .hist div:last-child{border-bottom:0}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #1f2430} th{color:#cbd5e1;text-align:left}
  .right{text-align:right}
  .r-perfect{background:var(--r-perfect);color:#191622}
  .r-select{background:var(--r-select);color:#081a2c}
  .r-optimal{background:var(--r-optimal);color:#062226}
  .r-tactical{background:var(--r-tactical);color:#2d2200}
  .r-common{background:var(--r-common);color:#0c1116}
</style>
</head>
<body>
<div class="wrap">
  <h1>카드 뽑기 시뮬레이터</h1>
  <div class="sub">확률은 2005년 9월 카드 자판기 확률 참고 
    <a href="https://community.gnjoy.com/rom/Board/ROM21/180622" 
     target="_blank" rel="noopener noreferrer">
    (공식 게시글 보기)
  </a></div>

  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="draw1" class="primary" disabled>1회 뽑기</button>
        <button id="draw10" disabled>10회 뽑기</button>
        <button id="reset" disabled>리셋</button>
      </div>
      <div id="loadState" class="tag">불러오는 중…</div>
    </div>
    <div id="lastResult" class="result">아직 결과 없음</div>
    <div style="margin-top:10px">
      <div class="muted" style="margin-bottom:6px">히스토리</div>
      <div id="history" class="hist"></div>
    </div>
  </div>

  <div class="panel">
    <div class="muted" style="margin-bottom:8px">그룹별 확률 (공개)</div>
    <table id="groupTable"></table>
  </div>

  <div class="panel">
    <div class="muted" style="margin-bottom:8px">아이템 목록/확률 (공개)</div>
    <table id="itemTable"></table>
  </div>
</div>

<script>
/* ===== 확률은 probabilities.txt(정적 파일)에서만 로드 ===== */

/** 1) 붙여넣기 텍스트를 관대하게 보정 */
function normalizeRaw(raw){
  return raw.replace(/\r/g,'')
            // "(0.07%)" 같은 그룹 확률 뒤에 바로 글자가 오면 줄바꿈 삽입
            .replace(/%\)\s*(?=\S)/g, '%)\n')
            // 탭/스페이스 정규화
            .replace(/[ \t]+/g, m => m.includes('\t') ? '\t' : ' ')
            .trim();
}

/** 2) 그룹/아이템/확률 파싱 (소수점 8자리 반올림) */
function parseProbabilityText(raw){
  const text = normalizeRaw(raw);
  const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);

  const groups=[]; let current=null; let pendingName=null;
  const groupFull=/^(.+?)\s*\(([\d.]+)%\)\s*$/;   // "그룹 (x%)"
  const onlyPct=/^\(([\d.]+)%\)\s*$/;             // "(x%)"만
  const itemTailPct=/^(.*?)\s*(?:\t|\s{2,}|\s)\s*([\d.]+)%[^%]*$/; // 아이템 줄
  const round8 = v => Math.round(parseFloat(v) * 1e8) / 1e8;

  for (const line of lines){
    if (groupFull.test(line)){
      const [,n,p]=line.match(groupFull);
      current = { name:n.trim(), pct:round8(p), items:[] };
      groups.push(current); pendingName=null; continue;
    }
    if (onlyPct.test(line) && pendingName){
      const [,p]=line.match(onlyPct);
      current = { name:pendingName.trim(), pct:round8(p), items:[] };
      groups.push(current); pendingName=null; continue;
    }
    if (!onlyPct.test(line) && !itemTailPct.test(line) && !groupFull.test(line)){
      pendingName = line; continue; // 그룹명만 먼저 온 줄
    }
    const m = line.match(itemTailPct);
    if (m && current){
      const name = m[1].trim();
      const pct  = round8(m[2]);
      if (!isNaN(pct)) current.items.push({ name, pct });
    }
  }
  return groups;
}

/** 3) 가중치 랜덤 선택 */
function pickWeighted(arr,key='pct'){
  const sum = arr.reduce((s,a)=>s+a[key],0);
  let r = Math.random()*sum, acc=0;
  for(const it of arr){ acc+=it[key]; if(r<=acc) return it; }
  return arr.at(-1);
}

/* ---------------- UI 바인딩 ---------------- */
const el = {
  draw1:document.getElementById('draw1'),
  draw10:document.getElementById('draw10'),
  reset:document.getElementById('reset'),
  last:document.getElementById('lastResult'),
  hist:document.getElementById('history'),
  groupT:document.getElementById('groupTable'),
  itemT:document.getElementById('itemTable'),
  state:document.getElementById('loadState')
};

let GROUPS=[], CNT={total:0,group:{},item:{}};

function rarityClass(n){
  if(n.includes('퍼펙트'))return'r-perfect';
  if(n.includes('셀렉션'))return'r-select';
  if(n.includes('옵티멀'))return'r-optimal';
  if(n.includes('택틱컬'))return'r-tactical';
  return'r-common';
}

function renderTables(groups){
  // 그룹별
  let ghtml=`<tr><th>그룹</th><th class="right">공식확률</th><th class="right">아이템합</th><th class="right">차이</th></tr>`;
  for(const g of groups){
    const sum=g.items.reduce((s,i)=>s+i.pct,0);
    const diff=Math.abs(sum-g.pct);
    const cls=diff<0.001?'ok':diff<0.01?'warn':'bad';
    ghtml+=`<tr>
      <td><span class="pill ${rarityClass(g.name)}">${g.name}</span></td>
      <td class="right">${g.pct.toFixed(8)}%</td>
      <td class="right">${sum.toFixed(8)}%</td>
      <td class="right ${cls}">${diff.toFixed(8)}%</td>
    </tr>`;
  }
  const total=groups.reduce((s,g)=>s+g.pct,0);
  ghtml+=`<tr><th>합계</th><th class="right">${total.toFixed(8)}%</th><th colspan="2"></th></tr>`;
  el.groupT.innerHTML=ghtml;

  // 아이템별
  let ihtml=`<tr><th style="width:42%">아이템</th><th>그룹</th><th class="right">확률</th></tr>`;
  for(const g of groups){
    for(const it of g.items){
      ihtml+=`<tr>
        <td>${it.name}</td>
        <td><span class="pill ${rarityClass(g.name)}">${g.name}</span></td>
        <td class="right">${it.pct.toFixed(8)}%</td>
      </tr>`;
    }
  }
  el.itemT.innerHTML=ihtml;
}

function reset(){
  CNT={total:0,group:{},item:{}};
  el.hist.innerHTML='';
  el.last.textContent='아직 결과 없음';
}

function draw(n=1){
  for(let k=0;k<n;k++){
    const g=pickWeighted(GROUPS,'pct');
    const it=pickWeighted(g.items,'pct');
    CNT.total++;
    CNT.group[g.name]=(CNT.group[g.name]||0)+1;
    CNT.item[it.name]=(CNT.item[it.name]||0)+1;

    el.last.innerHTML=`<span class="pill ${rarityClass(g.name)}">${g.name}</span>
      <div style="font-weight:800;font-size:18px">${it.name}</div>
      <div class="tag">아이템 확률 ${it.pct.toFixed(8)}%</div>
      <div class="tag">누적 ${CNT.total}회</div>`;
    const h=document.createElement('div');
    h.innerHTML=`<span>${CNT.total}. ${it.name}</span>
      <span class="pill ${rarityClass(g.name)}">${g.name}</span>`;
    el.hist.prepend(h);
  }
}

/* 확률 파일 로드 */
async function boot(){
  try{
    const res = await fetch('probabilities.txt',{cache:'no-cache'});
    if(!res.ok) throw new Error('확률 파일을 불러올 수 없습니다.');
    const raw = await res.text();
    GROUPS = parseProbabilityText(raw);
    if(!GROUPS.length) throw new Error('파싱 실패: 그룹 없음');

    renderTables(GROUPS);
    reset();
    el.draw1.disabled=el.draw10.disabled=el.reset.disabled=false;
    const total=GROUPS.reduce((s,g)=>s+g.pct,0);
    el.state.textContent=`로드 완료 · 그룹합 ${total.toFixed(8)}%`;
    el.state.className='tag ok';
  }catch(e){
    el.state.textContent=e.message;
    el.state.className='tag bad';
  }
}
el.draw1.onclick=()=>draw(1);
el.draw10.onclick=()=>draw(10);
el.reset.onclick=reset;
boot();
</script>
</body>
</html>
